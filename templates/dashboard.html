<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.8em; }
        header a, .btn { color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 5px; transition: background 0.3s; border: none; cursor: pointer; font-weight: 600; margin-left: 10px; }
        header a:hover, .btn:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .stat h3 { color: #667eea; font-size: 2.5em; margin: 10px 0; }
        .stat p { color: #666; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .tasks { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .task-header { padding: 20px; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .task-item { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .task-item:last-child { border-bottom: none; }
        .task-info { flex: 1; min-width: 250px; }
        .task-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .task-desc { color: #999; font-size: 0.9em; }
        .task-meta { display: flex; gap: 10px; align-items: center; }
        .task-status { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .status-pending { background: #ffeaa7; color: #d63031; }
        .status-in_progress { background: #74b9ff; color: #0984e3; }
        .status-completed { background: #55efc4; color: #00b894; }
        .task-priority { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .priority-low { background: #dfe6e9; color: #636e72; }
        .priority-medium { background: #fdcb6e; color: #d63031; }
        .priority-high { background: #ff7675; color: white; }
        .task-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        button, .btn-primary { padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: background 0.3s; }
        button:hover, .btn-primary:hover { background: #764ba2; }
        .btn-edit { background: #0984e3; }
        .btn-edit:hover { background: #0770c9; }
        .btn-delete { background: #d63031; }
        .btn-delete:hover { background: #b71c1c; }
        .btn-status { background: #6c5ce7; padding: 8px 10px; font-size: 0.85em; }
        .btn-status:hover { background: #5f3dc4; }
        .btn-create { background: #00b894; font-size: 1em; }
        .btn-create:hover { background: #00a085; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-header { font-size: 1.5em; font-weight: 700; margin-bottom: 20px; color: #667eea; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .modal-actions button { padding: 10px 20px; }
        .btn-cancel { background: #95a5a6; }
        .btn-cancel:hover { background: #7f8c8d; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ“‹ Dashboard</h1>
        <div>
            <span>Welcome, {{ user_name }}</span>
            <a href="/auth/logout">Logout</a>
        </div>
    </header>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div class="stats">
            <div class="stat">
                <p>Total Tasks</p>
                <h3 id="total">-</h3>
            </div>
            <div class="stat">
                <p>Completed</p>
                <h3 id="completed">-</h3>
            </div>
            <div class="stat">
                <p>In Progress</p>
                <h3 id="in-progress">-</h3>
            </div>
            <div class="stat">
                <p>Pending</p>
                <h3 id="pending">-</h3>
            </div>
        </div>

        <div class="section-header">
            <h2>Your Tasks</h2>
            <button class="btn-create" onclick="openCreateModal()">+ New Task</button>
        </div>

        <div class="tasks">
            <div id="tasks-list">
                {% if tasks %}
                    {% for task in tasks %}
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-title">{{ task.title }}</div>
                            {% if task.description %}<div class="task-desc">{{ task.description }}</div>{% endif %}
                            {% if task.due_date %}<div class="task-desc">ðŸ“… Due: {{ task.due_date.strftime('%b %d, %Y') }}</div>{% endif %}
                        </div>
                        <div class="task-meta">
                            <span class="task-status status-{{ task.status }}">{{ task.status.replace('_', ' ').title() }}</span>
                            <span class="task-priority priority-{{ task.priority }}">{{ task.priority.title() }}</span>
                        </div>
                        <div class="task-actions">
                            <button class="btn-status" onclick="updateStatus('{{ task.id }}')">âœ“ Status</button>
                            <button class="btn-edit" onclick="openEditModal('{{ task.id }}', '{{ task.title }}', '{{ task.description or '' }}', '{{ task.priority }}')">âœŽ Edit</button>
                            <button class="btn-delete" onclick="deleteTask('{{ task.id }}')">ðŸ—‘ Delete</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty">
                        <p>No tasks yet. Create one by clicking "+ New Task"!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Create New Task</div>
            <div class="form-group">
                <label>Task Title *</label>
                <input type="text" id="taskTitle" placeholder="Enter task title">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="taskDescription" placeholder="Enter task description"></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="taskPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="taskDueDate">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button class="btn-primary" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Task</div>
            <input type="hidden" id="editTaskId">
            <div class="form-group">
                <label>Task Title *</label>
                <input type="text" id="editTaskTitle" placeholder="Enter task title">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editTaskDescription" placeholder="Enter task description"></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="editTaskPriority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editTaskStatus">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="btn-primary" onclick="updateTask()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        // Get auth token from session
        function getAuthHeader() {
            return {
                'Authorization': `Bearer {{ session.get('access_token', '') }}`,
                'Content-Type': 'application/json'
            };
        }

        // Show alert message
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            setTimeout(() => alert.className = 'alert', 4000);
        }

        // Load stats from API
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    headers: getAuthHeader()
                });
                const stats = await response.json();
                document.getElementById('total').textContent = stats.total_tasks;
                document.getElementById('completed').textContent = stats.completed_tasks;
                document.getElementById('in-progress').textContent = stats.in_progress_tasks;
                document.getElementById('pending').textContent = stats.pending_tasks;
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        // Load tasks from API
        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    headers: getAuthHeader()
                });
                const tasks = await response.json();
                renderTasks(tasks);
                loadStats();
            } catch (e) {
                showAlert('Error loading tasks', 'error');
            }
        }

        // Render tasks to DOM
        function renderTasks(tasks) {
            const list = document.getElementById('tasks-list');
            if (tasks.length === 0) {
                list.innerHTML = '<div class="empty"><p>No tasks yet. Create one by clicking "+ New Task"!</p></div>';
                return;
            }
            
            list.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                        ${task.due_date ? `<div class="task-desc">ðŸ“… Due: ${new Date(task.due_date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'})}</div>` : ''}
                    </div>
                    <div class="task-meta">
                        <span class="task-status status-${task.status}">${task.status.replace('_', ' ')}</span>
                        <span class="task-priority priority-${task.priority}">${task.priority}</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-status" onclick="updateStatus('${task.id}')">âœ“ Status</button>
                        <button class="btn-edit" onclick="openEditModal('${task.id}', '${task.title}', '${task.description || ''}', '${task.priority}')">âœŽ Edit</button>
                        <button class="btn-delete" onclick="deleteTask('${task.id}')">ðŸ—‘ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Create Task
        async function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                showAlert('Please enter a task title', 'error');
                return;
            }

            const data = {
                title: title,
                description: document.getElementById('taskDescription').value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('Task created successfully!');
                    closeCreateModal();
                    loadTasks();
                } else {
                    showAlert('Error creating task', 'error');
                }
            } catch (e) {
                showAlert('Error creating task', 'error');
            }
        }

        // Update Task
        async function updateTask() {
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value.trim();
            if (!title) {
                showAlert('Please enter a task title', 'error');
                return;
            }

            const data = {
                title: title,
                description: document.getElementById('editTaskDescription').value,
                priority: document.getElementById('editTaskPriority').value,
                status: document.getElementById('editTaskStatus').value
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: getAuthHeader(),
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('Task updated successfully!');
                    closeEditModal();
                    loadTasks();
                } else {
                    showAlert('Error updating task', 'error');
                }
            } catch (e) {
                showAlert('Error updating task', 'error');
            }
        }

        // Delete Task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                if (response.ok) {
                    showAlert('Task deleted successfully!');
                    loadTasks();
                } else {
                    showAlert('Error deleting task', 'error');
                }
            } catch (e) {
                showAlert('Error deleting task', 'error');
            }
        }

        // Update Task Status
        async function updateStatus(taskId) {
            const statuses = ['pending', 'in_progress', 'completed'];
            const newStatus = prompt('New status:\n1. pending\n2. in_progress\n3. completed\n\nEnter status name:', 'pending');
            
            if (!newStatus || !statuses.includes(newStatus)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/status`, {
                    method: 'PATCH',
                    headers: getAuthHeader(),
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showAlert('Status updated!');
                    loadTasks();
                } else {
                    showAlert('Error updating status', 'error');
                }
            } catch (e) {
                showAlert('Error updating status', 'error');
            }
        }

        // Modal functions
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskDueDate').value = '';
        }

        function openEditModal(taskId, title, description, priority) {
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = title;
            document.getElementById('editTaskDescription').value = description;
            document.getElementById('editTaskPriority').value = priority;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createModal');
            const editModal = document.getElementById('editModal');
            
            if (event.target === createModal) closeCreateModal();
            if (event.target === editModal) closeEditModal();
        }

        // Load tasks on page load
        loadTasks();
    </script>
</body>
</html>
